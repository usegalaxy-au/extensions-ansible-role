---

- name: Include Galaxy version determination
  ansible.builtin.include_tasks: _inc_galaxy_version.yml

- name: Clone galaxy-extensions repository
  ansible.builtin.git:
    repo: "{{ galaxy_extensions_repo_url }}"
    dest: "{{ galaxy_extensions_repo_dir }}"
    version: "{{ galaxy_extensions_repo_version }}"
    update: true
    force: true
    accept_hostkey: true
  connection: local
  run_once: true
  environment:
    GIT_CONFIG_COUNT: "1"
    GIT_CONFIG_KEY_0: "safe.directory"
    GIT_CONFIG_VALUE_0: "{{ galaxy_extensions_repo_dir }}"

- name: Ensure destination directory exists
  ansible.builtin.file:
    path: "{{ galaxy_extensions_dir }}"
    state: directory
    owner: "{{ galaxy_extensions_owner }}"
    group: "{{ galaxy_extensions_group }}"
    mode: '0755'

- name: Check for builtin extensions
  ansible.builtin.stat:
    path: "{{ galaxy_extensions_builtin_dir }}/{{ item }}"
  register: builtin_extension_check
  loop: "{{ galaxy_extensions_enabled }}"

- name: Build list of third-party extensions (non-builtin)
  ansible.builtin.set_fact:
    galaxy_third_party_extensions_enabled: >-
      {{ (builtin_extension_check.results | default([]))
          | selectattr('stat.exists', 'equalto', False)
          | map(attribute='item') | list }}

- name: Collect paths of builtin extensions
  ansible.builtin.set_fact:
    galaxy_builtin_extension_paths: >-
      {{ galaxy_builtin_extension_paths | default([]) + [item.stat.path + '/'] }}
  loop: "{{ builtin_extension_check.results }}"
  when: item.stat.exists

- name: Collect paths of extensions to install
  ansible.builtin.set_fact:
    extension_paths: >-
      {{ extension_paths | default([]) + [
        galaxy_extensions_repo_dir + '/extensions/' +
        item.item + '/'
      ] }}
  loop: "{{ builtin_extension_check.results }}"
  when: not item.stat.exists

- name: Install builtin extensions
  ansible.builtin.shell:
    cmd: |
      cp -r "{{ item | regex_replace('/+$', '') }}" "{{ galaxy_extensions_dir }}/"
      chown -R {{ galaxy_extensions_owner }}:{{ galaxy_extensions_group }} \
        "{{ galaxy_extensions_dir }}/{{ item | basename }}"
  loop: "{{ galaxy_builtin_extension_paths | default([]) }}"
  changed_when: true
  notify: restart galaxy

- name: Select appropriate version for each extension based on Galaxy version
  select_extension_versions:
    paths: "{{ extension_paths }}"
    galaxy_version: "{{ galaxy_version }}"
  connection: local
  register: extension_version_paths_result

- name: Extract version paths from module result
  ansible.builtin.set_fact:
    extension_version_paths: "{{ extension_version_paths_result.result }}"

- name: Install each enabled extension
  ansible.builtin.include_tasks: install_extension.yml
  loop: "{{ galaxy_third_party_extensions_enabled | zip(extension_version_paths) | list }}"
  loop_control:
    loop_var: extension_item

- name: Collect existing extension directories
  ansible.builtin.command: ls -1 {{ galaxy_extensions_dir }}
  register: existing_extension_dirs
  changed_when: false

- name: Remove old extension directories
  ansible.builtin.file:
    path: "{{ galaxy_extensions_dir }}/{{ item }}"
    state: absent
  with_items: "{{ existing_extension_dirs.stdout_lines }}"
  when: "item not in galaxy_extensions_enabled"
  notify: restart galaxy
